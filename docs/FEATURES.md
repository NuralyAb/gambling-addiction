# Функциональность SafeBet AI

## Что работает

### Аутентификация
- **Регистрация** — email, пароль, Telegram username (обязателен). Верификация по ссылке (Resend).
- **Логин** — Credentials. Админы (ADMIN_EMAIL) перенаправляются на `/admin`, остальные — на `/dashboard`.
- **Сброс пароля** — запрос ссылки → переход по токену → новый пароль.

**Почему Telegram обязателен:** Платформа завязана на уведомления и отчёты через Telegram. Без username часть функций не работает.

---

### PGSI-тест
Стандартизированный опросник из 9 вопросов (0–3 балла). Результат: уровень риска (none/low/moderate/high). Обязателен перед доступом к дашборду.

**Почему так:** PGSI — валидированный инструмент. Без него AI-анализ не имеет базового контекста.

---

### Дневник и эпизоды
- **Записи дневника** — дата, настроение, заметки, тип (episode/note).
- **Эпизоды** — дата, сумма, длительность, настроение до/после, триггеры.

Данные используются для: нейросети, sentiment, аномалий, дашборда.

---

### AI-анализ (`/api/ai/analyze`)
Объединяет все 4 модуля:
1. Извлекает фичи из эпизодов, дневника, block_events
2. Вызывает `predictRisk()`, `analyzeTrend()`, `analyzeAnomalies()`
3. Возвращает JSON с предсказаниями, трендами, аномалиями, рекомендациями

**Почему один endpoint:** Один запрос — все данные уже загружены, меньше round-trips.

---

### Chrome-расширение
- Блокировка списка сайтов
- События блокировки → `block_events` (user_id, domain, timestamp)
- При 3+ блокировках за час → уведомление доверенному лицу (если подключено)

**Авторизация:** Токен `sba_xxx` из `extension_tokens` или user_id (legacy).

---

### Доверенное лицо
Пользователь указывает Telegram доверенного лица. При высоком риске (частые блокировки, высокий risk_score, ночная активность, SOS) — сообщение в Telegram.

**Что видит доверенное лицо:** Уровень риска, факт тревоги, имя пользователя, общие рекомендации. **Не видит:** дневник, чат, детали тестов.

---

### Telegram-бот
- Команды: /start, /dashboard, /report и т.д.
- Webhook или long polling
- Отправка отчётов по расписанию (daily/weekly/off)
- Уведомления доверенному лицу

---

### Админка (`/admin`)
- Доступ по `ADMIN_EMAIL` в .env
- Статистика: пользователи, записи дневника, сообщения чата, блокировки, PGSI
- Последние регистрации и блокировки
- Логи админов (таблица `admin_logs`)

**Отдельный layout** — без Sidebar, только заголовок и контент. Админ не видит обычную навигацию.

---

### Достижения
Бейджи за streak, количество записей, прохождение PGSI и т.д. Данные из `achievements` API.

---

### SOS-страница
Дыхательное упражнение (4-4-4), контакты помощи, кнопка «Попросить поддержку» → уведомление доверенному лицу.

---

### Обучение
Уроки о зависимости, калькулятор house edge, квизы. Прогресс в `localStorage` (клиент).
