# AI-модули SafeBet AI

## Принцип: 3 локальных + 1 внешний

Три модуля работают **полностью на сервере**, без внешних API. Один (чат) использует OpenAI. Это снижает стоимость, ускоряет ответы и повышает конфиденциальность.

---

## 1. Нейросеть предсказания риска (`src/lib/ai/neural-risk.ts`)

### Что делает
Предсказывает вероятность рецидива (0–100) на основе 6 поведенческих фичей.

### Архитектура
- **Входы (6):** частота эпизодов, тренд расходов, настроение, ночная активность, разнообразие триггеров, серия воздержания
- **Скрытые слои:** 8 → 4 нейрона (ReLU)
- **Выход:** 1 нейрон (sigmoid) → вероятность риска
- **Параметры:** ~89 (веса + смещения)

### Как реализовано
Чистый TypeScript: матричные операции (dot product, forward pass), без библиотек ML. Веса захардкожены — модель предобучена на синтетических паттернах зависимого поведения.

### Почему так
- **Нет внешних API** — работает офлайн, быстро, без затрат
- **Интерпретируемость** — можно показать важность фичей
- **Детерминированность** — одинаковый ввод → одинаковый вывод

---

## 2. NLP-анализ настроения (`src/lib/ai/sentiment-analysis.ts`)

### Что делает
Анализирует текст записей дневника: тональность, тренд, доминирующее настроение, серии негатива.

### Технология
- **Библиотека:** `sentiment` (AFINN-165 лексикон)
- **Дополнение:** русский лексикон для контекста зависимости (проигрыш, срыв, поддержка, прогресс и т.д.)

### Как реализовано
`analyzeText()` — оценка одной записи. `analyzeTrend()` — агрегация по всем записям за период: средний score, тренд (улучшение/ухудшение), предупреждения.

### Почему так
- **Локально** — 0 внешних запросов
- **Русский язык** — свой лексикон поверх AFINN
- **Контекст зависимости** — слова вроде «срыв», «проигрыш» имеют больший вес

---

## 3. Детектор аномалий (`src/lib/ai/anomaly-detector.ts`)

### Что делает
Находит необычные паттерны в расходах и частоте эпизодов (Z-score метод).

### Алгоритм
- Вычисление среднего и стандартного отклонения по временному ряду
- Z-score = (значение − среднее) / std
- |Z| > 2.5 → критическая аномалия, |Z| > 1.5 → предупреждение

### Как реализовано
Чистая математика, без внешних сервисов. Вход — массив `{ date, value }`, выход — массив с флагами `isAnomaly`, `severity`.

### Почему так
- **Простота** — Z-score хорошо работает для одномерных рядов
- **Прозрачность** — понятно, почему точка помечена как аномалия
- **Быстро** — O(n)

---

## 4. AI-чат (`src/app/api/chat/route.ts`)

### Что делает
Эмпатичный диалог в стиле мотивационного интервьюирования. Streaming-ответы.

### Технология
- **OpenAI API** (gpt-4o-mini по умолчанию)
- **System prompt** — правила: не осуждать, задавать открытые вопросы, при суицидальных мыслях — контакты помощи

### Анонимизация
Перед отправкой в OpenAI:
- `user_id`, email, имя, телефон **никогда не передаются**
- Текст сообщений проходит через `anonymizeText()`: маскируются email, телефоны (regex)
- В контекст попадают только `role` и обезличенный `content`

### Почему так
- **OpenAI** — сильный языковой модель для диалога
- **Анонимизация** — соответствие Privacy Policy, минимизация PII
- **Streaming** — быстрый отклик для пользователя
